<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPZD Model Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
        }
        #container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        #controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        .control-group label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }
        .control-group input[type="range"] {
            width: 100%;
        }
        .control-group .value-display {
            font-size: 11px;
            color: #999;
            text-align: right;
        }
        button {
            padding: 10px 20px;
            font-size: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.reset {
            background-color: #f44336;
        }
        button.reset:hover {
            background-color: #da190b;
        }
        #viz-toggle {
            background-color: #2196F3;
        }
        #viz-toggle:hover {
            background-color: #1976D2;
        }
        .speed-btn {
            padding: 8px 15px;
            font-size: 12px;
            background-color: #e0e0e0;
            color: #333;
            border: 2px solid transparent;
        }
        .speed-btn:hover {
            background-color: #d0d0d0;
        }
        .speed-btn.active {
            background-color: #FF9800;
            color: white;
            border-color: #F57C00;
        }
        .speed-btn.active:hover {
            background-color: #FB8C00;
        }
        #canvas-container {
            margin-top: 20px;
        }
        .info {
            margin-top: 20px;
            padding: 15px;
            background-color: #e7f3fe;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
        }
        .info h3 {
            margin-top: 0;
            color: #1976D2;
        }
        .info p {
            margin: 5px 0;
            font-size: 14px;
        }
        footer {
            margin-top: 40px;
            padding: 20px;
            border-top: 2px solid #e0e0e0;
            background-color: #f9f9f9;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        footer a {
            color: #2196F3;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
        footer .credits {
            margin-top: 10px;
            font-size: 13px;
            color: #888;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Interactive simulation of Nutrient-Phytoplankton-Zooplankton-Detritus dynamics</h1>
        <p>
            Based on:
            <a href="https://academic.oup.com/plankt/article/23/4/389/1436426">Edwards, A. M. Adding detritus to a nutrient – phytoplankton – zooplankton model : a dynamical-systems approach. J. Plankton Res. 23, 389–413 (2001).</a>

        </p>
        <div class="info">
            <h3>Model Equations</h3>
            <p><strong>dN/dt</strong> = -V<sub>m</sub>(N/(K<sub>N</sub>+N))f(I<sub>0</sub>)P + αR<sub>m</sub>(1-e<sup>-λP</sup>)Z + εP + gZ + φD</p>
            <p><strong>dP/dt</strong> = V<sub>m</sub>(N/(K<sub>N</sub>+N))f(I<sub>0</sub>)P - R<sub>m</sub>(1-e<sup>-λP</sup>)Z - εP - rP</p>
            <p><strong>dZ/dt</strong> = βR<sub>m</sub>(1-e<sup>-λP</sup>)Z - gZ</p>
            <p><strong>dD/dt</strong> = rP + (1-α-β)R<sub>m</sub>(1-e<sup>-λP</sup>)Z - φD</p>
        </div>

        <div class="info" style="background-color: #f3f9e7; border-left-color: #4CAF50;">
            <h3 style="color: #2E7D32;">Parameter Descriptions</h3>

            <p><strong>State Variables:</strong></p>
            <p style="margin-left: 20px;">
                <strong>N</strong> = Nutrient concentration (e.g., nitrogen, phosphorus)<br>
                <strong>P</strong> = Phytoplankton biomass concentration<br>
                <strong>Z</strong> = Zooplankton biomass concentration<br>
                <strong>D</strong> = Detritus concentration (dead organic matter)
            </p>

            <p><strong>Phytoplankton Growth Parameters:</strong></p>
            <p style="margin-left: 20px;">
                <strong>V<sub>m</sub></strong> = Maximum nutrient uptake rate by phytoplankton<br>
                <strong>K<sub>N</sub></strong> = Half-saturation constant for nutrient uptake (Michaelis-Menten kinetics)<br>
                <strong>I<sub>0</sub></strong> = Light intensity/availability for photosynthesis
            </p>

            <p><strong>Grazing Parameters:</strong></p>
            <p style="margin-left: 20px;">
                <strong>R<sub>m</sub></strong> = Maximum grazing rate of zooplankton on phytoplankton<br>
                <strong>λ</strong> = Ivlev constant (controls saturation in Ivlev grazing function)
            </p>

            <p><strong>Efficiency/Partitioning Parameters:</strong></p>
            <p style="margin-left: 20px;">
                <strong>α</strong> = Fraction of grazing that is excreted/egested back to nutrients<br>
                <strong>β</strong> = Fraction of grazing that is assimilated into zooplankton biomass<br>
                <strong>(1-α-β)</strong> = Fraction of grazing that becomes detritus
            </p>

            <p><strong>Loss/Mortality Parameters:</strong></p>
            <p style="margin-left: 20px;">
                <strong>ε</strong> = Phytoplankton mortality/excretion rate<br>
                <strong>g</strong> = Zooplankton mortality rate<br>
                <strong>r</strong> = Phytoplankton sinking/loss rate (to detritus)<br>
                <strong>φ</strong> = Detritus remineralization rate (breakdown back to nutrients)
            </p>

            <p><strong>Functional Forms:</strong></p>
            <p style="margin-left: 20px;">
                <strong>N/(K<sub>N</sub>+N)</strong> = Michaelis-Menten nutrient limitation (0 to 1)<br>
                <strong>1-e<sup>-λP</sup></strong> = Ivlev grazing function (saturation at high P)
            </p>
        </div>
        <div class="info" style="background-color: #edededed; border-left-color: #d0003b;">
            <h3 style="color: #333;">How to Run:</h3>
            <p>Start by pushing the <strong>Start/Pause</strong> button below.</p>
            <p>You can toggle between the <strong>Flow Diagram View</strong> and the <strong>Time Series View</strong>.</p>
            <p>You can increase the timestep by selecting a <strong>Speed Multiplier</strong></p>
        </div>
        <div id="controls">
            <!-- Biological Parameters -->
            <div class="control-group">
                <label>V<sub>m</sub> (Max uptake): <span class="value-display" id="vm-val">1.50</span></label>
                <input type="range" id="vm" min="0.1" max="3" step="0.1" value="1.5">
            </div>

            <div class="control-group">
                <label>K<sub>N</sub> (Half-saturation): <span class="value-display" id="kn-val">0.50</span></label>
                <input type="range" id="kn" min="0.1" max="2" step="0.1" value="0.5">
            </div>

            <div class="control-group">
                <label>I<sub>0</sub> (Light): <span class="value-display" id="i0-val">1.00</span></label>
                <input type="range" id="i0" min="0" max="2" step="0.1" value="1.0">
            </div>

            <div class="control-group">
                <label>R<sub>m</sub> (Max grazing): <span class="value-display" id="rm-val">1.00</span></label>
                <input type="range" id="rm" min="0.1" max="3" step="0.1" value="1.0">
            </div>

            <div class="control-group">
                <label>λ (Ivlev constant): <span class="value-display" id="lambda-val">1.00</span></label>
                <input type="range" id="lambda" min="0.1" max="3" step="0.1" value="1.0">
            </div>

            <div class="control-group">
                <label>α (Grazing to N): <span class="value-display" id="alpha-val">0.30</span></label>
                <input type="range" id="alpha" min="0" max="1" step="0.05" value="0.3">
            </div>

            <div class="control-group">
                <label>β (Grazing to Z): <span class="value-display" id="beta-val">0.30</span></label>
                <input type="range" id="beta" min="0" max="1" step="0.05" value="0.3">
            </div>

            <div class="control-group">
                <label>ε (P mortality): <span class="value-display" id="epsilon-val">0.05</span></label>
                <input type="range" id="epsilon" min="0" max="0.5" step="0.01" value="0.05">
            </div>

            <div class="control-group">
                <label>g (Z mortality): <span class="value-display" id="g-val">0.10</span></label>
                <input type="range" id="g" min="0" max="0.5" step="0.01" value="0.1">
            </div>

            <div class="control-group">
                <label>r (P sinking): <span class="value-display" id="r-val">0.05</span></label>
                <input type="range" id="r" min="0" max="0.5" step="0.01" value="0.05">
            </div>

            <div class="control-group">
                <label>φ (D remineralization): <span class="value-display" id="phi-val">0.10</span></label>
                <input type="range" id="phi" min="0" max="0.5" step="0.01" value="0.1">
            </div>
        </div>

        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button onclick="toggleSimulation()">Start/Pause</button>
            <button class="reset" onclick="resetSimulation()">Reset</button>
            <button id="viz-toggle" onclick="toggleVisualization()">Show Flow Diagram</button>

            <div style="display: flex; gap: 5px; align-items: center; margin-left: 20px;">
                <span style="font-size: 14px; color: #666;">Speed:</span>
                <button class="speed-btn active" onclick="setSpeed(1)">1x</button>
                <button class="speed-btn" onclick="setSpeed(2)">2x</button>
                <button class="speed-btn" onclick="setSpeed(4)">4x</button>
                <button class="speed-btn" onclick="setSpeed(10)">10x</button>
            </div>
        </div>

        <div id="canvas-container"></div>

        <footer>
            <div>
                <strong>Patrick Daniel</strong> | UC Santa Cruz<br>
                <a href="https://github.com/patcdaniel" target="_blank">GitHub</a>
            </div>
            <div class="credits">
                Inspired by <a href="https://github.com/bradyrx/NPZD-Model/blob/master/NPZD-Model.ipynb" target="_blank">bradyrx/NPZD-Model</a>
            </div>
        </footer>

    </div>

    <script src="sketch.js"></script>
</body>
</html>
